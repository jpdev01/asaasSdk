name: Deploy Maven

on:
    push:
        tags:
            - 'v*'

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Java 11
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '11'
                  cache: maven

            # Importa GPG
            - name: Import GPG key
              run: |
                  echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
                  gpg --list-secret-keys --keyid-format LONG

            # Cria settings.xml dinÃ¢mico
            - name: Create Maven settings.xml
              run: |
                  mkdir -p ~/.m2
                  cat > ~/.m2/settings.xml <<EOF
                  <settings>
                    <servers>
                      <server>
                        <id>central</id>
                        <username>${{ secrets.OSSRH_USERNAME }}</username>
                        <password>${{ secrets.OSSRH_TOKEN }}</password>
                      </server>
                    </servers>

                    <profiles>
                      <profile>
                        <id>gpg</id>
                        <properties>
                          <gpg.passphrase>${{ secrets.GPG_PASSPHRASE }}</gpg.passphrase>
                        </properties>
                      </profile>
                    </profiles>

                    <activeProfiles>
                      <activeProfile>gpg</activeProfile>
                    </activeProfiles>
                  </settings>
                  EOF

            -   name: Debug settings
                run: cat ~/.m2/settings.xml

            # Deploy
            - name: Maven deploy
              run: mvn clean deploy -Dmaven.test.skip=true
              env:
                  OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
                  OSSRH_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
                  GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                  GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
